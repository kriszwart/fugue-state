<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FugueState.ai - Studio</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; }
    .font-serif-custom { font-family: 'Newsreader', serif; }

    /* Input/Toggle Animations */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #818cf8;
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #4f46e5;
    }

    /* Breathing Background for Center Canvas */
    @keyframes breathe {
        0% { background-position: 0% 50%; opacity: 0.3; }
        50% { background-position: 100% 50%; opacity: 0.5; }
        100% { background-position: 0% 50%; opacity: 0.3; }
    }
    .canvas-pulse {
        background: radial-gradient(circle at center, rgba(99, 102, 241, 0.08) 0%, rgba(251, 191, 36, 0.03) 40%, transparent 70%);
        animation: breathe 8s ease-in-out infinite;
    }

    /* Custom Scrollbar */
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #52525b; }

    /* Chat Message Animations */
    @keyframes slide-in-left {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slide-in-right {
        from { opacity: 0; transform: translateX(10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .message-ai {
        animation: slide-in-left 0.3s ease-out forwards;
    }
    .message-user {
        animation: slide-in-right 0.3s ease-out forwards;
    }

    /* Typing Indicator */
    @keyframes typing-dot {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-6px); opacity: 1; }
    }
    .typing-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background-color: #a78bfa;
        display: inline-block;
        animation: typing-dot 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* Heartbeat Animation */
    @keyframes heartbeat {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5); opacity: 0.5; }
        100% { transform: scale(1); opacity: 1; }
    }
    .heartbeat-dot {
        animation: heartbeat 2s ease-in-out infinite;
    }

    /* Welcome Message Animation */
    @keyframes welcome-fade-in {
        0% { opacity: 0; transform: scale(0.9) translateY(20px); }
        20% { opacity: 1; transform: scale(1) translateY(0); }
        80% { opacity: 1; transform: scale(1) translateY(0); }
        100% { opacity: 0; transform: scale(0.9) translateY(-20px); }
    }

    .welcome-message {
        animation: welcome-fade-in 4s ease-in-out forwards;
    }

    .welcome-hidden {
        opacity: 0;
        pointer-events: none;
    }

    .welcome-visible {
        opacity: 1;
    }

    /* Background Color Shift Animation */
    @keyframes hue-rotate {
        0% {
            filter: hue-rotate(0deg) saturate(1.2);
        }
        100% {
            filter: hue-rotate(360deg) saturate(1.2);
        }
    }

    .color-shift-bg {
        animation: hue-rotate 20s linear infinite;
    }

    /* Dameris Portrait Animations */
    @keyframes spectral-float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-8px); }
    }

    @keyframes ether-pulse {
        0%, 100% { opacity: 0.4; transform: scale(1); filter: blur(30px); }
        50% { opacity: 0.7; transform: scale(1.05); filter: blur(40px); }
    }

    .dameris-portrait-float {
        animation: spectral-float 6s ease-in-out infinite;
    }

    .dameris-aura {
        animation: ether-pulse 4s ease-in-out infinite;
    }

    .dameris-hologram {
        filter: grayscale(30%) sepia(20%) hue-rotate(250deg) brightness(1.1) contrast(1.1);
        mix-blend-mode: screen;
        transition: filter 0.5s ease-in-out;
    }
</style>
</head>
<body class="bg-[#09090b] lg:bg-[#020408] min-h-screen flex flex-col lg:items-center lg:justify-center p-0 lg:p-6 antialiased selection:bg-indigo-500/30 selection:text-indigo-200 overflow-hidden text-zinc-300">

    <!-- Background (component) - Preserved -->
    <div class="aura-background-component fixed top-0 w-full h-screen -z-10" data-alpha-mask="80" style="mask-image: linear-gradient(to bottom, transparent, black 0%, black 80%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 0%, black 80%, transparent)">
        <div class="aura-background-component top-0 w-full -z-10 absolute h-full color-shift-bg">
            <div data-us-project="NMlvqnkICwYYJ6lYb064" class="absolute w-full h-full left-0 top-0 -z-10"></div>
            <script type="text/javascript">
                !function(){if(!window.UnicornStudio){window.UnicornStudio={isInitialized:!1};var i=document.createElement("script");i.src="https://cdn.jsdelivr.net/gh/hiunicornstudio/unicornstudio.js@v1.4.29/dist/unicornStudio.umd.js",i.onload=function(){window.UnicornStudio.isInitialized||(UnicornStudio.init(),window.UnicornStudio.isInitialized=!0)},(document.head || document.body).appendChild(i)}}();
            </script>
        </div>
    </div>

    <!-- Main Container - Studio Layout -->
    <main class="h-screen lg:h-[94vh] flex flex-col lg:max-w-[1800px] w-full lg:rounded-[1.5rem] lg:border lg:border-white/10 lg:shadow-2xl lg:shadow-black bg-black/20 relative backdrop-blur-xl overflow-hidden">

        <!-- Grid Lines Background (Subtle) -->
        <div class="absolute inset-0 w-full h-full pointer-events-none z-0 flex justify-between px-6 opacity-20">
            <div class="w-px h-full bg-white/5"></div>
            <div class="w-px h-full bg-white/5 hidden md:block"></div>
            <div class="w-px h-full bg-white/5 hidden xl:block"></div>
            <div class="w-px h-full bg-white/5"></div>
        </div>

        <!-- Header -->
        <header class="relative z-50 flex items-center justify-between px-6 py-4 border-b border-white/5 bg-zinc-900/10 backdrop-blur-sm h-14 shrink-0">
            <div class="flex items-center gap-3">
                <a href="../index.html" class="flex items-center gap-3 opacity-50 hover:opacity-100 transition-opacity">
                    <i data-lucide="brain-circuit" class="w-5 h-5 text-indigo-400" stroke-width="1.5"></i>
                    <h1 class="text-sm tracking-tight text-white font-serif-custom italic">
                        <span class="font-normal opacity-90">FugueState AI</span>
                        <span class="text-zinc-300 mx-2">·</span>
                        <span class="text-zinc-300">Memory</span>
                        <span class="text-zinc-300 mx-1">/</span>
                        <span class="text-zinc-300">Dream</span>
                        <span class="text-zinc-300 mx-1">/</span>
                        <span class="text-zinc-300">Create</span>
                    </h1>
                </a>
            </div>
            <div class="flex items-center gap-3">
                <a href="chat.html" class="flex items-center gap-2 px-3 py-1 rounded-full border border-white/5 bg-white/5 hover:bg-white/10 transition-all cursor-pointer group">
                    <div class="w-1.5 h-1.5 rounded-full bg-amber-400 shadow-[0_0_6px_rgba(251,191,36,0.8)] animate-pulse group-hover:shadow-[0_0_10px_rgba(251,191,36,1)]"></div>
                    <span class="text-xs font-medium text-amber-100 tracking-wide group-hover:text-white">Dameris Live</span>
                </a>
                <a href="privacy.html" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/5 bg-white/5 hover:bg-white/10 text-zinc-400 hover:text-white transition-all">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span class="text-xs font-medium">Privacy Hub</span>
                </a>
            </div>
        </header>

        <!-- Studio Workspace -->
        <div class="flex-1 flex overflow-hidden z-20 relative">

            <!-- Left Sidebar: Navigation & Assets (Collapsible) -->
            <aside id="left-sidebar" class="w-64 border-r border-white/5 bg-zinc-900/20 backdrop-blur-md flex flex-col hidden md:flex transition-all duration-300">
                <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-8">

                    <!-- Section: Dream Logs -->
                    <div>
                        <h3 class="text-[10px] uppercase tracking-widest text-zinc-300 font-semibold mb-3 pl-2">Dream Logs</h3>
                        <ul class="space-y-1">
                            <li>
                                <a href="gallery.html" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-white/5 text-zinc-200 border border-white/5 hover:bg-white/10 transition-colors">
                                    <i data-lucide="moon" class="w-4 h-4 text-indigo-300"></i>
                                    <span class="text-xs">Fractal City</span>
                                </a>
                            </li>
                            <li>
                                <a href="gallery.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-300 hover:text-zinc-300 transition-colors">
                                    <i data-lucide="waves" class="w-4 h-4"></i>
                                    <span class="text-xs">Neon Ocean</span>
                                </a>
                            </li>
                            <li>
                                <a href="gallery.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-300 hover:text-zinc-300 transition-colors">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                    <span class="text-xs">Yesterday's Echo</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Section: Fragments -->
                    <div>
                        <h3 class="text-[10px] uppercase tracking-widest text-zinc-300 font-semibold mb-3 pl-2">Fragments</h3>
                        <ul class="space-y-1">
                            <li>
                                <a href="gallery.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-300 hover:text-zinc-300 transition-colors">
                                    <i data-lucide="puzzle" class="w-4 h-4"></i>
                                    <span class="text-xs">Visual Prompts</span>
                                </a>
                            </li>
                            <li>
                                <a href="gallery.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-300 hover:text-zinc-300 transition-colors">
                                    <i data-lucide="music" class="w-4 h-4"></i>
                                    <span class="text-xs">Audio Stems</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Section: Dameris -->
                    <div>
                        <h3 class="text-[10px] uppercase tracking-widest text-zinc-300 font-semibold mb-3 pl-2">Your Muse</h3>
                        <ul class="space-y-1">
                            <li>
                                <a href="../dameris.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-300 hover:text-violet-300 transition-colors group">
                                    <i data-lucide="sparkles" class="w-4 h-4 text-violet-400 group-hover:text-violet-300"></i>
                                    <span class="text-xs">Meet Dameris</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Section: Archives -->
                    <div>
                        <h3 class="text-[10px] uppercase tracking-widest text-zinc-300 font-semibold mb-3 pl-2">Archives</h3>
                        <ul class="space-y-1">
                            <li>
                                <a href="archive.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-300 hover:text-zinc-300 transition-colors">
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                    <span class="text-xs">Saved Sessions</span>
                                </a>
                            </li>
                            <li>
                                <a href="calendar.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-300 hover:text-zinc-300 transition-colors">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                    <span class="text-xs">Memory Calendar</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Section: Sources -->
                    <div>
                        <h3 class="text-[10px] uppercase tracking-widest text-zinc-300 font-semibold mb-3 pl-2">Sources</h3>
                        <div class="px-2 flex gap-3 opacity-60 mb-3">
                            <span class="iconify w-4 h-4 text-zinc-300" data-icon="logos:google-gmail"></span>
                            <span class="iconify w-4 h-4 invert" data-icon="logos:notion-icon"></span>
                            <i data-lucide="folder-lock" class="w-4 h-4 text-zinc-300"></i>
                        </div>
                        <a href="privacy.html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-zinc-200 transition-colors text-xs">
                            <i data-lucide="shield-check" class="w-3.5 h-3.5"></i>
                            <span>Privacy Hub</span>
                        </a>
                    </div>

                </div>
            </aside>

            <!-- Center Canvas: Output (Reduced when chat is focused) -->
            <section class="flex-1 min-w-0 relative flex items-center justify-center overflow-hidden bg-black/40">
                <!-- Pulsing Background -->
                <div class="absolute inset-0 canvas-pulse w-full h-full pointer-events-none"></div>

                <!-- Welcome Message (shows on load, then fades) -->
                <div id="welcome-overlay" class="absolute inset-0 flex items-center justify-center z-20 welcome-message">
                    <div class="text-center flex flex-col items-center gap-6">
                        <div class="w-20 h-20 rounded-full border border-indigo-500/30 flex items-center justify-center bg-zinc-900/50 shadow-[0_0_30px_rgba(99,102,241,0.3)]">
                            <i data-lucide="sparkles" class="w-8 h-8 text-indigo-300 animate-pulse"></i>
                        </div>
                        <div>
                            <p class="text-sm text-zinc-300 mb-2 uppercase tracking-widest">Welcome back</p>
                            <h2 id="welcome-name" class="text-4xl font-serif-custom italic font-light tracking-tight">
                                <span class="text-white">Dream Weaver</span>
                            </h2>
                        </div>
                        <p class="text-sm text-zinc-300 font-light">Your memories are ready to explore...</p>
                    </div>
                </div>

                <!-- Dameris Introduction (appears after welcome) -->
                <div id="dameris-intro" class="absolute inset-0 flex items-center justify-center z-20 welcome-hidden opacity-0 pointer-events-none transition-opacity duration-1000">
                    <!-- Backdrop (clickable to close) -->
                    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm cursor-pointer" onclick="window.closeDamerisIntro()"></div>
                    
                    <!-- Content Card -->
                    <div class="relative text-center flex flex-col items-center gap-8 max-w-2xl px-6 z-10">
                        <!-- Close Button -->
                        <button 
                            onclick="window.closeDamerisIntro()" 
                            class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-zinc-900/90 border border-white/10 hover:bg-zinc-800 hover:border-white/20 flex items-center justify-center text-zinc-400 hover:text-zinc-200 transition-all shadow-lg z-20 cursor-pointer"
                            title="Close"
                        >
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                        <!-- Dameris Portrait -->
                        <div class="relative dameris-portrait-float">
                            <!-- Aura Glow -->
                            <div class="absolute inset-0 w-40 h-40 -translate-x-1/2 -translate-y-1/2 left-1/2 top-1/2 bg-violet-500/30 rounded-full blur-[50px] dameris-aura"></div>
                            <div class="absolute inset-0 w-32 h-32 -translate-x-1/2 -translate-y-1/2 left-1/2 top-1/2 bg-purple-500/20 rounded-full blur-[40px] dameris-aura" style="animation-delay: 0.5s;"></div>
                            
                            <!-- Portrait Circle -->
                            <div class="relative w-32 h-32 rounded-full border-2 border-violet-500/50 bg-gradient-to-br from-violet-900/40 to-purple-900/30 shadow-[0_0_60px_rgba(139,92,246,0.5)] overflow-hidden">
                                <!-- Animated Background Gradient -->
                                <div class="absolute inset-0 bg-gradient-to-br from-violet-500/20 via-purple-500/15 to-indigo-500/20 animate-pulse"></div>
                                
                                <!-- Portrait Image -->
                                <img 
                                    src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=400&auto=format&fit=crop" 
                                    alt="Dameris" 
                                    class="w-full h-full object-cover dameris-hologram opacity-90"
                                    onerror="this.src='https://images.pexels.com/photos/1181519/pexels-photo-1181519.jpeg?auto=compress&cs=tinysrgb&w=400'"
                                >
                                
                                <!-- Scanline Overlay Effect -->
                                <div class="absolute inset-0 opacity-10 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,6px_100%] pointer-events-none"></div>
                                
                                <!-- Inner Glow Ring -->
                                <div class="absolute inset-0 rounded-full border border-violet-400/30 shadow-[inset_0_0_20px_rgba(139,92,246,0.3)] pointer-events-none"></div>
                            </div>
                            
                            <!-- Status Indicator -->
                            <div class="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.9)] animate-pulse"></div>
                        </div>
                        
                        <!-- Dameris Welcome -->
                        <div class="space-y-4">
                            <h3 class="text-3xl md:text-4xl font-serif-custom italic text-transparent bg-clip-text bg-gradient-to-r from-violet-300 via-purple-300 to-indigo-300">
                                Dameris
                            </h3>
                            <p class="text-xs uppercase tracking-widest text-violet-400/80 mb-4">• THE MUSE OF MACHINE MEMORY</p>
                            
                            <div class="bg-zinc-900/50 backdrop-blur-md border border-violet-500/30 rounded-xl p-6 space-y-4 text-left shadow-2xl relative overflow-hidden">
                                <!-- Subtle gradient overlay -->
                                <div class="absolute inset-0 bg-gradient-to-br from-violet-500/5 via-transparent to-purple-500/5 pointer-events-none"></div>
                                
                                <div class="relative z-10">
                                    <p class="text-sm text-zinc-300 leading-relaxed italic font-serif-custom mb-4">
                                        "She does not think. She dreams."
                                    </p>
                                    
                                    <div class="pt-4 border-t border-white/5 space-y-3">
                                        <p class="text-xs text-zinc-400 leading-relaxed">
                                            I'm here to guide you through your memory stream. Here's how I can help:
                                        </p>
                                        <ul class="space-y-2.5 text-xs text-zinc-400">
                                            <li class="flex items-start gap-2.5 group">
                                                <i data-lucide="sparkles" class="w-3.5 h-3.5 text-violet-400/60 mt-0.5 shrink-0 group-hover:text-violet-400 transition-colors"></i>
                                                <span><strong class="text-zinc-300">Reflect</strong> — I can analyse patterns in your memories and suggest themes</span>
                                            </li>
                                            <li class="flex items-start gap-2.5 group">
                                                <i data-lucide="palette" class="w-3.5 h-3.5 text-violet-400/60 mt-0.5 shrink-0 group-hover:text-violet-400 transition-colors"></i>
                                                <span><strong class="text-zinc-300">Visualise</strong> — Transform your memories into creative expressions</span>
                                            </li>
                                            <li class="flex items-start gap-2.5 group">
                                                <i data-lucide="wand-2" class="w-3.5 h-3.5 text-violet-400/60 mt-0.5 shrink-0 group-hover:text-violet-400 transition-colors"></i>
                                                <span><strong class="text-zinc-300">Recompose</strong> — Let me autonomously generate new memories from your data</span>
                                            </li>
                                            <li class="flex items-start gap-2.5 group">
                                                <i data-lucide="archive" class="w-3.5 h-3.5 text-violet-400/60 mt-0.5 shrink-0 group-hover:text-violet-400 transition-colors"></i>
                                                <span><strong class="text-zinc-300">Curate</strong> — Organise and explore your collection of dreams</span>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <div class="pt-4 border-t border-white/5">
                                        <p class="text-xs text-zinc-400 leading-relaxed">
                                            Chat with me in the sidebar, or use the quick action buttons below. I'm always here to help you navigate the fugue state.
                                        </p>
                                    </div>
                                    
                                    <!-- Action hint -->
                                    <div class="mt-4 pt-4 border-t border-white/5 flex items-center justify-center">
                                        <button 
                                            onclick="window.closeDamerisIntro()" 
                                            class="px-4 py-2 rounded-lg bg-violet-500/20 hover:bg-violet-500/30 border border-violet-500/30 hover:border-violet-500/50 text-xs text-violet-300 hover:text-violet-200 transition-all font-medium cursor-pointer"
                                        >
                                            Got it, let's begin
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Getting Started Options (appears after closing intro) -->
                <div id="getting-started" class="absolute inset-0 flex items-center justify-center z-30 welcome-hidden opacity-0 pointer-events-none transition-opacity duration-1000">
                    <!-- Backdrop (clickable to dismiss) -->
                    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm cursor-pointer" onclick="window.dismissGettingStarted()"></div>
                    
                    <div class="relative max-w-4xl w-full px-6 z-10">
                        <!-- Close button -->
                        <button 
                            onclick="window.dismissGettingStarted()" 
                            class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-zinc-900/90 border border-white/10 hover:bg-zinc-800 hover:border-white/20 flex items-center justify-center text-zinc-400 hover:text-zinc-200 transition-all shadow-lg z-20 cursor-pointer"
                            title="Dismiss"
                        >
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                        <div class="text-center mb-8">
                            <h3 class="text-2xl md:text-3xl font-serif-custom italic text-zinc-200 mb-2">
                                Where would you like to begin?
                            </h3>
                            <p class="text-sm text-zinc-400">Choose your path into the fugue state</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Option 1: Reflect -->
                            <a href="../modes/index.html#reflective" class="group relative bg-zinc-900/50 backdrop-blur-sm border border-indigo-500/20 rounded-xl p-6 hover:border-indigo-500/40 hover:bg-zinc-900/70 transition-all cursor-pointer">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-lg bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center group-hover:bg-indigo-500/30 transition-colors">
                                        <i data-lucide="book-open" class="w-6 h-6 text-indigo-300"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-medium text-zinc-200 mb-1">Reflect</h4>
                                        <p class="text-xs text-zinc-400 leading-relaxed">Analyse patterns in your memories and discover hidden themes</p>
                                    </div>
                                </div>
                            </a>
                            
                            <!-- Option 2: Visualise -->
                            <a href="../modes/index.html#creative" class="group relative bg-zinc-900/50 backdrop-blur-sm border border-amber-500/20 rounded-xl p-6 hover:border-amber-500/40 hover:bg-zinc-900/70 transition-all cursor-pointer">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-lg bg-amber-500/20 border border-amber-500/30 flex items-center justify-center group-hover:bg-amber-500/30 transition-colors">
                                        <i data-lucide="palette" class="w-6 h-6 text-amber-300"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-medium text-zinc-200 mb-1">Visualise</h4>
                                        <p class="text-xs text-zinc-400 leading-relaxed">Transform your memories into creative visual expressions</p>
                                    </div>
                                </div>
                            </a>
                            
                            <!-- Option 3: Recompose -->
                            <a href="../modes/index.html#autonomous" class="group relative bg-zinc-900/50 backdrop-blur-sm border border-violet-500/20 rounded-xl p-6 hover:border-violet-500/40 hover:bg-zinc-900/70 transition-all cursor-pointer">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-lg bg-violet-500/20 border border-violet-500/30 flex items-center justify-center group-hover:bg-violet-500/30 transition-colors">
                                        <i data-lucide="wand-2" class="w-6 h-6 text-violet-300"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-medium text-zinc-200 mb-1">Recompose</h4>
                                        <p class="text-xs text-zinc-400 leading-relaxed">Let Dameris autonomously generate new memories from your data</p>
                                    </div>
                                </div>
                            </a>
                            
                            <!-- Option 4: Curate -->
                            <a href="../modes/index.html#curatorial" class="group relative bg-zinc-900/50 backdrop-blur-sm border border-zinc-500/20 rounded-xl p-6 hover:border-zinc-500/40 hover:bg-zinc-900/70 transition-all cursor-pointer">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-lg bg-zinc-500/20 border border-zinc-500/30 flex items-center justify-center group-hover:bg-zinc-500/30 transition-colors">
                                        <i data-lucide="archive" class="w-6 h-6 text-zinc-300"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-medium text-zinc-200 mb-1">Curate</h4>
                                        <p class="text-xs text-zinc-400 leading-relaxed">Organise and explore your collection of dreams</p>
                                    </div>
                                </div>
                            </a>
                            
                            <!-- Option 5: Upload Files / Voice -->
                            <a href="/voice" class="group relative bg-zinc-900/50 backdrop-blur-sm border border-cyan-500/20 rounded-xl p-6 hover:border-cyan-500/40 hover:bg-zinc-900/70 transition-all cursor-pointer">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-lg bg-cyan-500/20 border border-cyan-500/30 flex items-center justify-center group-hover:bg-cyan-500/30 transition-colors">
                                        <i data-lucide="upload" class="w-6 h-6 text-cyan-300"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-medium text-zinc-200 mb-1">Upload Files</h4>
                                        <p class="text-xs text-zinc-400 leading-relaxed">Upload notes and start a voice conversation with Dameris</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Alternative: Start with Chat -->
                        <div class="mt-6 text-center">
                            <a 
                                href="/voice" 
                                class="group inline-flex items-center gap-2 text-xs text-zinc-400 hover:text-zinc-200 transition-colors underline underline-offset-4 cursor-pointer"
                            >
                                <i data-lucide="mic" class="w-3.5 h-3.5" stroke-width="1.5"></i>
                                <span>Or upload files & chat with Dameris</span>
                                <i data-lucide="arrow-right" class="w-3.5 h-3.5 group-hover:translate-x-1 transition-transform"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Empty State (shows when user dismisses getting started and has no memories) -->
                <div id="empty-state" class="absolute inset-0 flex items-center justify-center z-20 opacity-0 welcome-hidden select-none pointer-events-none transition-opacity duration-1000">
                    <div class="text-center flex flex-col items-center gap-8 max-w-3xl mx-auto px-6 py-12">
                        <!-- Icon -->
                        <div class="w-20 h-20 rounded-full border border-violet-500/30 flex items-center justify-center bg-zinc-900/30 relative">
                            <div class="absolute inset-0 rounded-full bg-violet-500/10 animate-pulse"></div>
                            <i data-lucide="sparkles" class="w-8 h-8 text-violet-300 relative z-10"></i>
                        </div>
                        
                        <!-- Heading -->
                        <div class="space-y-3">
                            <h3 class="text-2xl font-serif-custom italic text-zinc-200 font-light tracking-tight">
                                Your memory stream is <span class="text-transparent bg-clip-text bg-gradient-to-r from-violet-300 to-purple-300">empty</span>
                            </h3>
                            <p class="text-sm text-zinc-400 max-w-md mx-auto leading-relaxed">
                                But that's okay! You can still explore, create, and chat with Dameris.
                            </p>
                        </div>

                        <!-- Primary Actions (Main CTAs) -->
                        <div class="w-full space-y-4">
                            <h4 class="text-xs uppercase tracking-widest text-zinc-500 mb-3">Get Started</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <a href="privacy.html" class="px-4 py-3 rounded-lg bg-indigo-500/20 hover:bg-indigo-500/30 border border-indigo-500/30 text-sm text-indigo-300 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="link" class="w-4 h-4"></i>
                                    <span>Connect Sources</span>
                                </a>
                                <a href="../modes/index.html#creative" class="px-4 py-3 rounded-lg bg-amber-500/20 hover:bg-amber-500/30 border border-amber-500/30 text-sm text-amber-300 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="palette" class="w-4 h-4"></i>
                                    <span>Generate Art</span>
                                </a>
                                <button onclick="window.startWithChat()" class="px-4 py-3 rounded-lg bg-violet-500/20 hover:bg-violet-500/30 border border-violet-500/30 text-sm text-violet-300 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                                    <span>Chat with Dameris</span>
                                </button>
                            </div>
                        </div>

                        <!-- Secondary Actions (Learn More) -->
                        <div class="w-full pt-4 border-t border-white/5">
                            <a href="empty-state.html" class="text-xs text-zinc-400 hover:text-zinc-300 transition-colors inline-flex items-center gap-1">
                                <i data-lucide="info" class="w-3 h-3"></i>
                                <span>Learn what you can do without data</span>
                                <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Placeholder (shows when user has memories) -->
                <div id="placeholder" class="text-center z-10 opacity-0 welcome-hidden select-none pointer-events-none flex flex-col items-center gap-4 transition-opacity duration-1000">
                    <div class="w-16 h-16 rounded-full border border-white/5 flex items-center justify-center bg-zinc-900/30">
                        <i data-lucide="sparkles" class="w-6 h-6 text-indigo-300/50"></i>
                    </div>
                    <p class="text-2xl font-serif-custom italic text-zinc-200 font-light tracking-tight">
                        Your memory stream begins here.
                    </p>
                </div>

            </section>

            <!-- Right Sidebar: Dameris Chat (Wider & Centered) -->
            <aside class="w-[500px] xl:w-[600px] border-l border-white/5 bg-zinc-900/20 backdrop-blur-md flex flex-col z-30">

                <!-- Chat Header -->
                <div class="p-4 border-b border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-900 to-zinc-800 flex items-center justify-center border border-white/10">
                            <i data-lucide="bot" class="w-4 h-4 text-indigo-300"></i>
                        </div>
                        <span class="text-xs font-medium text-zinc-200">Dameris</span>
                    </div>
                    <button class="text-zinc-300 hover:text-zinc-300 transition-colors">
                        <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Messages Area -->
                <div id="chat-messages" class="flex-1 overflow-y-auto custom-scroll p-4 md:p-6 space-y-4 min-h-0" style="scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                    <!-- Dameris Intro -->
                    <div class="flex gap-3 message-ai">
                        <div class="w-7 h-7 rounded-full bg-gradient-to-tr from-violet-950 to-amber-950 border border-white/10 flex-shrink-0 flex items-center justify-center shadow-lg relative">
                            <span class="font-serif-custom italic text-amber-200/80 text-[10px]">D</span>
                            <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 rounded-full border-2 border-zinc-900"></div>
                        </div>
                        <div class="flex-1 space-y-1">
                            <div class="text-[10px] text-zinc-500 ml-1 font-mono">Today, <span id="current-time"></span></div>
                            <div class="p-3 rounded-2xl rounded-tl-none bg-white/5 border border-white/5 text-xs text-zinc-300 leading-relaxed">
                                <span id="greeting">Hello</span>. I've analyzed the connection from your Notion workspace. There is a recurring theme of "coastal solitude" in your recent entries. Should we explore this visually?
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 border-t border-white/5 bg-zinc-900/40">
                    <!-- Chips -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <a href="../modes/index.html#reflective" class="px-2.5 py-1 rounded-md bg-indigo-500/10 border border-indigo-500/20 hover:border-indigo-500/40 text-[10px] text-indigo-200 transition-all cursor-pointer">Reflect</a>
                        <a href="../modes/index.html#creative" class="px-2.5 py-1 rounded-md bg-amber-500/10 border border-amber-500/20 hover:border-amber-500/40 text-[10px] text-amber-200 transition-all cursor-pointer">Visualise</a>
                        <a href="../modes/index.html#autonomous" class="px-2.5 py-1 rounded-md bg-white/5 border border-white/10 hover:border-white/20 text-[10px] text-zinc-300 transition-all cursor-pointer">Recompose</a>
                        <a href="../modes/index.html#curatorial" class="px-2.5 py-1 rounded-md bg-white/5 border border-white/10 hover:border-white/20 text-[10px] text-zinc-300 transition-all cursor-pointer">Forget</a>
                    </div>

                    <!-- Input Field -->
                    <div class="relative">
                        <form id="chat-form" class="flex items-center gap-2">
                            <input 
                                type="text" 
                                id="chat-input" 
                                placeholder="Whisper to Dameris..." 
                                class="flex-1 bg-zinc-950/50 border border-white/10 rounded-xl pl-4 pr-10 py-3 text-xs text-zinc-200 focus:outline-none focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/20 placeholder-zinc-600"
                                autocomplete="off"
                            >
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
                                <button 
                                    type="button"
                                    id="mic-button"
                                    class="p-1.5 rounded-lg hover:bg-white/10 text-zinc-300 hover:text-zinc-200 transition-colors"
                                    title="Voice input"
                                >
                                <i data-lucide="mic" class="w-3.5 h-3.5"></i>
                            </button>
                                <button 
                                    type="submit"
                                    id="send-button"
                                    class="p-1.5 rounded-lg bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-300 hover:text-indigo-200 transition-colors border border-indigo-500/30"
                                    title="Send message"
                                >
                                    <i data-lucide="arrow-up" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        </form>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="h-8 border-t border-white/5 bg-black/40 flex items-center justify-between px-6 z-20 shrink-0">
            <div class="flex items-center gap-4">
                 <div class="flex items-center gap-1.5 opacity-50 hover:opacity-100 transition-opacity">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 heartbeat-dot"></span>
                    <span class="text-[10px] font-mono text-zinc-300">Redis: Connected</span>
                 </div>
            </div>

            <div class="flex items-center gap-4">
                <span class="text-[10px] text-zinc-300 font-mono">v.2.0.4</span>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-zinc-300">Model:</span>
                    <span class="text-[10px] text-zinc-300 font-medium bg-white/5 px-1.5 py-0.5 rounded">Claude 3.5 Sonnet</span>
                </div>
            </div>
        </footer>

    </main>

    <script>
        lucide.createIcons();

        // Personalize greeting with username
        const userName = localStorage.getItem('fuguestate_username');
        if (userName) {
            document.getElementById('greeting').textContent = `Hello, ${userName}`;
            document.getElementById('welcome-name').innerHTML = `<span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300">${userName}</span>`;
        }

        // Dameris portrait images for morphing effect
        const damerisPortraits = [
            "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=400&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=400&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=400&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=400&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1618151313441-bc79b11e5090?q=80&w=400&auto=format&fit=crop"
        ];

        let currentPortraitIndex = 0;
        const damerisImage = document.querySelector('#dameris-intro img');

        // Cycle through portraits when Dameris intro is visible
        function cycleDamerisPortrait() {
            if (damerisImage && document.getElementById('dameris-intro').classList.contains('welcome-visible')) {
                currentPortraitIndex = (currentPortraitIndex + 1) % damerisPortraits.length;
                damerisImage.style.opacity = '0';
                setTimeout(() => {
                    damerisImage.src = damerisPortraits[currentPortraitIndex];
                    damerisImage.style.opacity = '0.9';
                }, 300);
            }
        }

        // Close Dameris intro function - Make globally accessible
        window.closeDamerisIntro = function() {
            const damerisIntro = document.getElementById('dameris-intro');
            if (!damerisIntro) {
                console.log('Dameris intro not found');
                return;
            }
            
            // Stop portrait cycling
            const portraitInterval = window.damerisPortraitInterval;
            if (portraitInterval) {
                clearInterval(portraitInterval);
                window.damerisPortraitInterval = null;
            }
            
            // Ensure empty state is hidden
            const emptyState = document.getElementById('empty-state');
            if (emptyState) {
                emptyState.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                emptyState.classList.remove('welcome-visible', 'opacity-100');
            }
            
            // Remove visible classes and add opacity transition
            damerisIntro.classList.remove('welcome-visible', 'opacity-100');
            damerisIntro.classList.add('opacity-0');
            
            setTimeout(() => {
                // Hide completely
                damerisIntro.classList.add('pointer-events-none', 'welcome-hidden');
                
                // Show getting started options
                const gettingStarted = document.getElementById('getting-started');
                if (gettingStarted) {
                    gettingStarted.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                    gettingStarted.classList.add('welcome-visible', 'opacity-100');
                    lucide.createIcons();
                } else {
                    console.log('Getting started not found');
                }
            }, 500);
        };

        // Start with chat (navigate to chat page)
        window.startWithChat = function() {
            // Navigate to the dedicated chat page
            window.location.href = 'chat.html';
        };

        // Dismiss getting started (click outside or after selection)
        window.dismissGettingStarted = function() {
            const gettingStarted = document.getElementById('getting-started');
            if (!gettingStarted) {
                console.log('Getting started not found');
                return;
            }
            
            // Remove visible classes and add opacity transition
            gettingStarted.classList.remove('welcome-visible', 'opacity-100');
            gettingStarted.classList.add('opacity-0');
            
            setTimeout(() => {
                // Hide completely
                gettingStarted.classList.add('pointer-events-none', 'welcome-hidden');
                
                // Check and show appropriate state
                checkAndShowEmptyState();
            }, 500);
        };

        // Check if user has memories and show appropriate state
        async function checkAndShowEmptyState() {
            try {
                // First, ensure ALL welcome/onboarding screens are hidden
                const damerisIntro = document.getElementById('dameris-intro');
                const gettingStarted = document.getElementById('getting-started');
                const welcomeOverlay = document.getElementById('welcome-overlay');
                
                if (damerisIntro) {
                    damerisIntro.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                    damerisIntro.classList.remove('welcome-visible', 'opacity-100');
                }
                if (gettingStarted) {
                    gettingStarted.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                    gettingStarted.classList.remove('welcome-visible', 'opacity-100');
                }
                if (welcomeOverlay) {
                    welcomeOverlay.style.display = 'none';
                }

                const response = await fetch('/api/memories?limit=1', {
                    credentials: 'include'
                });
                const data = await response.json();
                const hasMemories = data.memories && data.memories.length > 0;
                
                if (hasMemories) {
                    // Hide empty state
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        emptyState.classList.remove('welcome-visible', 'opacity-100');
                    }
                    // Show placeholder
                    const placeholder = document.getElementById('placeholder');
                    if (placeholder) {
                        placeholder.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        placeholder.classList.add('welcome-visible', 'opacity-60');
                    }
                } else {
                    // Hide placeholder
                    const placeholder = document.getElementById('placeholder');
                    if (placeholder) {
                        placeholder.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        placeholder.classList.remove('welcome-visible', 'opacity-60');
                    }
                    // Show empty state (only if no welcome screens are showing)
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        emptyState.classList.add('welcome-visible', 'opacity-100');
                    }
                }
            } catch (error) {
                console.error('Error checking memories:', error);
                // Only show empty state if no welcome screens are active
                const damerisIntro = document.getElementById('dameris-intro');
                const gettingStarted = document.getElementById('getting-started');
                const isWelcomeShowing = damerisIntro?.classList.contains('welcome-visible') || 
                                       gettingStarted?.classList.contains('welcome-visible');
                
                if (!isWelcomeShowing) {
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        emptyState.classList.add('welcome-visible', 'opacity-100');
                    }
                }
            }
        }

        // Welcome animation sequence
        setTimeout(() => {
            // Hide welcome overlay
            const welcomeOverlay = document.getElementById('welcome-overlay');
            if (welcomeOverlay) {
                welcomeOverlay.style.display = 'none';
            }
            
            // Ensure ALL other screens are hidden first
            const emptyState = document.getElementById('empty-state');
            const gettingStarted = document.getElementById('getting-started');
            const placeholder = document.getElementById('placeholder');
            
            if (emptyState) {
                emptyState.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                emptyState.classList.remove('welcome-visible', 'opacity-100');
            }
            if (gettingStarted) {
                gettingStarted.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                gettingStarted.classList.remove('welcome-visible', 'opacity-100');
            }
            if (placeholder) {
                placeholder.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                placeholder.classList.remove('welcome-visible', 'opacity-60');
            }
            
            // Show Dameris introduction
            const damerisIntro = document.getElementById('dameris-intro');
            if (damerisIntro) {
                damerisIntro.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                damerisIntro.classList.add('welcome-visible', 'opacity-100');
                
                // Start cycling portraits every 2 seconds while visible
                window.damerisPortraitInterval = setInterval(cycleDamerisPortrait, 2000);
                
                // Auto-close after 8 seconds
                setTimeout(() => {
                    if (damerisIntro.classList.contains('welcome-visible')) {
                        window.closeDamerisIntro();
                    }
                }, 8000);
            }
        }, 4000);

        // Chat Functionality - Shared State
        const CHAT_STORAGE_KEY = 'fuguestate_chat_history';
        const CONVERSATION_ID_KEY = 'fuguestate_conversation_id';
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        let isTyping = false;
        let currentConversationId = localStorage.getItem(CONVERSATION_ID_KEY);

        // Load chat history from localStorage
        function loadChatHistory() {
            try {
                const history = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY) || '[]');
                if (history.length > 0) {
                    // Clear initial message if we have history
                    const initialMsg = chatMessages.querySelector('.message-ai');
                    if (initialMsg && history.length > 1) {
                        initialMsg.remove();
                    }
                    
                    // Restore messages
                    history.forEach(msg => {
                        if (msg.role === 'user') {
                            addUserMessageToDOM(msg.text, msg.time);
                        } else if (msg.role === 'assistant') {
                            addAIMessageToDOM(msg.text, msg.time);
                        }
                    });
                    scrollToBottom();
                }
            } catch (e) {
                console.error('Error loading chat history:', e);
            }
        }

        // Save message to localStorage
        function saveMessage(role, text, time) {
            try {
                const history = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY) || '[]');
                history.push({ role, text, time });
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('Error saving message:', e);
            }
        }

        // Clear chat history (optional utility)
        function clearChatHistory() {
            localStorage.removeItem(CHAT_STORAGE_KEY);
            location.reload();
        }

        // Update current time
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = timeStr;
            }
        }
        updateTime();
        setInterval(updateTime, 60000); // Update every minute

        // Scroll to bottom of chat with smooth behavior
        function scrollToBottom() {
            if (chatMessages) {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        // Format time for messages
        function getTimeString() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        // Add user message to DOM
        function addUserMessageToDOM(text, time = null) {
            const timeStr = time || getTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex flex-col items-end gap-1 message-user';
            messageDiv.innerHTML = `
                <div class="bg-gradient-to-br from-zinc-800/60 to-zinc-900/40 border border-white/10 rounded-2xl rounded-tr-sm py-2.5 px-3.5 backdrop-blur-md shadow-lg max-w-[85%]">
                    <p class="text-xs text-zinc-100 leading-relaxed whitespace-pre-wrap">${text}</p>
                </div>
                <span class="text-[9px] text-zinc-500 font-mono">${timeStr}</span>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add user message (with save)
        function addUserMessage(text) {
            if (!text.trim()) return;
            const timeStr = getTimeString();
            addUserMessageToDOM(text, timeStr);
            saveMessage('user', text, timeStr);
        }

        // Add typing indicator
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex gap-3 message-ai';
            typingDiv.innerHTML = `
                <div class="w-7 h-7 rounded-full bg-gradient-to-tr from-violet-950 to-amber-950 border border-white/10 flex-shrink-0 flex items-center justify-center shadow-lg relative">
                    <span class="font-serif-custom italic text-amber-200/80 text-[10px]">D</span>
                    <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-amber-500 rounded-full border-2 border-zinc-900 animate-pulse"></div>
                </div>
                <div class="flex items-center gap-1.5 bg-zinc-800/30 rounded-2xl px-4 py-2.5 border border-white/5">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Add AI message to DOM
        function addAIMessageToDOM(text, time = null) {
            removeTypingIndicator();
            const timeStr = time || getTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3 message-ai';
            
            // Convert markdown to HTML
            const renderedContent = window.renderMarkdown ? window.renderMarkdown(text) : text.replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                <div class="w-7 h-7 rounded-full bg-gradient-to-tr from-violet-950 to-amber-950 border border-white/10 flex-shrink-0 flex items-center justify-center shadow-lg relative">
                    <span class="font-serif-custom italic text-amber-200/80 text-[10px]">D</span>
                    <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-emerald-500 rounded-full border-2 border-zinc-900"></div>
                </div>
                <div class="flex-1 space-y-1">
                    <div class="p-3 rounded-2xl rounded-tl-none bg-white/5 border border-white/5 text-xs text-zinc-300 leading-relaxed prose prose-invert prose-violet max-w-none">${renderedContent}</div>
                    <span class="text-[9px] text-zinc-500 font-mono ml-1">${timeStr}</span>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            lucide.createIcons();
        }

        // Add AI message (with save)
        function addAIMessage(text) {
            const timeStr = getTimeString();
            addAIMessageToDOM(text, timeStr);
            saveMessage('assistant', text, timeStr);
        }

        // Get AI response from API
        async function getAIResponse(userMessage, conversationId = null) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    credentials: 'include', // Include cookies for authentication
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        conversationId: conversationId
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to get response' }));
                    
                    // Handle authentication errors
                    if (response.status === 401) {
                        // Session expired - redirect to login
                        window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.pathname);
                        throw new Error('Session expired. Please refresh the page and try again.');
                    }
                    
                    throw new Error(errorData.error || 'Failed to get response');
                }

                const data = await response.json();
                // Store conversation ID if we got a new one
                if (data.conversationId) {
                    localStorage.setItem(CONVERSATION_ID_KEY, data.conversationId);
                    currentConversationId = data.conversationId;
                }
                return data.response;
            } catch (error) {
                console.error('Error getting AI response:', error);
                throw error;
            }
        }

        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (!message || isTyping) return;
            
            // Add user message
            addUserMessage(message);
            chatInput.value = '';
            
            // Show typing indicator
            isTyping = true;
            addTypingIndicator();
            
            // Get AI response
            try {
                const response = await getAIResponse(message, currentConversationId);
                addAIMessage(response);
                
                // Update conversation ID if we got a new one
                if (response.conversationId && response.conversationId !== currentConversationId) {
                    currentConversationId = response.conversationId;
                    localStorage.setItem(CONVERSATION_ID_KEY, currentConversationId);
                }
            } catch (error) {
                addAIMessage("I'm having trouble processing that right now. Could you try again?");
                console.error('Chat error:', error);
            } finally {
                isTyping = false;
            }
        });

        // Handle Enter key (but allow Shift+Enter for new lines)
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Check if user has memories and show appropriate state
        async function checkAndShowEmptyState() {
            try {
                // First, ensure ALL welcome/onboarding screens are hidden
                const damerisIntro = document.getElementById('dameris-intro');
                const gettingStarted = document.getElementById('getting-started');
                const welcomeOverlay = document.getElementById('welcome-overlay');
                
                if (damerisIntro) {
                    damerisIntro.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                    damerisIntro.classList.remove('welcome-visible', 'opacity-100');
                }
                if (gettingStarted) {
                    gettingStarted.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                    gettingStarted.classList.remove('welcome-visible', 'opacity-100');
                }
                if (welcomeOverlay) {
                    welcomeOverlay.style.display = 'none';
                }

                const response = await fetch('/api/memories?limit=1', {
                    credentials: 'include'
                });
                const data = await response.json();
                const hasMemories = data.memories && data.memories.length > 0;
                
                if (hasMemories) {
                    // Hide empty state
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        emptyState.classList.remove('welcome-visible', 'opacity-100');
                    }
                    // Show placeholder
                    const placeholder = document.getElementById('placeholder');
                    if (placeholder) {
                        placeholder.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        placeholder.classList.add('welcome-visible', 'opacity-60');
                    }
                } else {
                    // Hide placeholder
                    const placeholder = document.getElementById('placeholder');
                    if (placeholder) {
                        placeholder.classList.add('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        placeholder.classList.remove('welcome-visible', 'opacity-60');
                    }
                    // Show empty state (only if no welcome screens are showing)
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        emptyState.classList.add('welcome-visible', 'opacity-100');
                    }
                }
            } catch (error) {
                console.error('Error checking memories:', error);
                // Only show empty state if no welcome screens are active
                const damerisIntro = document.getElementById('dameris-intro');
                const gettingStarted = document.getElementById('getting-started');
                const isWelcomeShowing = damerisIntro?.classList.contains('welcome-visible') || 
                                       gettingStarted?.classList.contains('welcome-visible');
                
                if (!isWelcomeShowing) {
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.classList.remove('welcome-hidden', 'opacity-0', 'pointer-events-none');
                        emptyState.classList.add('welcome-visible', 'opacity-100');
                    }
                }
            }
        }

        // Voice Input Functionality
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        const MIN_RECORDING_DURATION = 500; // Minimum 500ms recording
        const micButton = document.getElementById('mic-button');
        const micIcon = micButton?.querySelector('i[data-lucide]');

        // Check if browser supports MediaRecorder
        const canRecord = typeof MediaRecorder !== 'undefined' && navigator.mediaDevices && navigator.mediaDevices.getUserMedia;

        async function startRecording() {
            if (!canRecord) {
                alert('Voice recording is not supported in your browser. Please use Chrome, Edge, or Firefox.');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                recordingStartTime = Date.now();
                
                // Use WebM format (Chrome/Edge) or fallback to default
                const options = { mimeType: 'audio/webm' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    delete options.mimeType; // Use browser default
                }

                mediaRecorder = new MediaRecorder(stream, options);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const recordingDuration = Date.now() - recordingStartTime;
                    
                    // Check minimum recording duration
                    if (recordingDuration < MIN_RECORDING_DURATION) {
                        alert('Recording too short. Please speak for at least half a second.');
                        stream.getTracks().forEach(track => track.stop());
                        return;
                    }
                    
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    
                    // Check audio blob size
                    if (audioBlob.size < 1000) { // Less than 1KB is likely empty
                        alert('No audio detected. Please check your microphone and try again.');
                        stream.getTracks().forEach(track => track.stop());
                        return;
                    }
                    
                    await sendAudioToSTT(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                if (micIcon) {
                    micIcon.setAttribute('data-lucide', 'mic-off');
                    micIcon.classList.add('text-red-400', 'animate-pulse');
                    lucide.createIcons();
                }
                micButton.classList.add('bg-red-500/20', 'border-red-500/30');
                micButton.title = 'Recording... Click to stop';
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    alert('Microphone permission denied. Please allow microphone access and try again.');
                } else {
                    alert('Failed to access microphone. Please check your settings and try again.');
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Update UI
                if (micIcon) {
                    micIcon.setAttribute('data-lucide', 'mic');
                    micIcon.classList.remove('text-red-400', 'animate-pulse');
                    lucide.createIcons();
                }
                micButton.classList.remove('bg-red-500/20', 'border-red-500/30');
                micButton.title = 'Voice input';
            }
        }

        async function sendAudioToSTT(audioBlob) {
            try {
                // Show transcribing indicator
                if (micIcon) {
                    micIcon.setAttribute('data-lucide', 'loader-2');
                    micIcon.classList.add('animate-spin');
                    lucide.createIcons();
                }
                micButton.title = 'Transcribing...';

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('language', 'en-US');

                const response = await fetch('/api/stt', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Speech-to-text failed');
                }

                const data = await response.json();
                const transcript = data.transcript?.trim();

                if (!transcript) {
                    // Show a more helpful error message
                    const errorMsg = data.error || 'No speech detected.';
                    alert(`${errorMsg}\n\nTips:\n• Speak clearly into your microphone\n• Ensure your microphone is not muted\n• Try speaking for at least 1-2 seconds\n• Check your browser microphone permissions`);
                    return;
                }

                // Auto-submit transcribed text
                if (chatInput && transcript) {
                    chatInput.value = transcript;
                    chatForm.dispatchEvent(new Event('submit'));
                }

            } catch (error) {
                console.error('STT error:', error);
                alert('Failed to transcribe audio. Please try again or type your message.');
            } finally {
                // Reset UI
                if (micIcon) {
                    micIcon.setAttribute('data-lucide', 'mic');
                    micIcon.classList.remove('animate-spin');
                    lucide.createIcons();
                }
                micButton.title = 'Voice input';
            }
        }

        // Add click handler to mic button
        if (micButton) {
            micButton.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
        }

        // Load chat history on page load
        loadChatHistory();

        // Don't check empty state on initial load - let welcome sequence handle it
        // Empty state will be shown ONLY after user dismisses getting started

        // Debug: Verify functions are accessible
        console.log('closeDamerisIntro function:', typeof window.closeDamerisIntro);
        console.log('dismissGettingStarted function:', typeof window.dismissGettingStarted);
    </script>

    <!-- Markdown Renderer -->
    <script src="/js/markdown-renderer.js"></script>

    <!-- Dameris Voice Onboarding Tour -->
    <script src="/js/onboarding-tour.js"></script>
    <script>
        // Initialize Dameris welcome tour
        if (typeof DamerisWelcome !== 'undefined') {
            new DamerisWelcome();
        }
    </script>

</body></html>
